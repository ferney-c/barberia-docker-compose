services:
  
  # 1. Servicio Frontend (Angular/Ionic con Hot Reload)
  frontend:
    build:
      context: ../barberia-frontend
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - "8080:8100"  # Puerto de Ionic dev server
      - "35729:35729"  # Puerto para LiveReload
    volumes:
      # Montamos el código fuente para Hot Reload
      - ../barberia-frontend:/app
      # Excluimos node_modules para evitar conflictos
      - /app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true  # Mejora la detección de cambios en Windows
      - WATCHPACK_POLLING=true
    command: npm start -- --host=0.0.0.0 --port=8100 --disable-host-check
    networks:
      - barber-connect-net
    restart: unless-stopped

  # 2. Servicio del Servidor Web del Backend (Nginx)
  nginx:
    image: nginx:alpine
    container_name: backend_server
    ports:
      - "9000:80"
    volumes:
      # Montamos el código del backend para Hot Reload
      - ../barberia-backend:/var/www/html
      # Configuración de Nginx para Laravel
      - ../barberia-backend/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend
      - mysql
    networks:
      - barber-connect-net
    restart: unless-stopped

  # 3. Servicio de la Aplicación Backend (Laravel/PHP-FPM con Hot Reload)
  backend:
    build:
      context: ../barberia-backend
      dockerfile: Dockerfile
    container_name: backend_app
    volumes:
      # Montamos el código para Hot Reload
      - ../barberia-backend:/var/www/html
      # Excluimos vendor para mejor performance
      - /var/www/html/vendor
    environment:
      - DB_CONNECTION=mysql
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_DATABASE=laravel_db
      - DB_USERNAME=root
      - DB_PASSWORD=barber_secret
    depends_on:
      - mysql
    networks:
      - barber-connect-net
    restart: unless-stopped
  
  # 4. Servicio de Base de Datos (MySQL)
  mysql:
    image: mysql:8.0
    container_name: mysql
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: barber_secret
      MYSQL_DATABASE: laravel_db
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - barber-connect-net
    restart: unless-stopped

volumes:
  mysql_data:

networks:
  barber-connect-net:
    driver: bridge